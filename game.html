<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>
	</head>
	<body>
		<canvas id="example"></canvas>
		<script type="text/javascript">
			var pixiRenderer = PIXI.autoDetectRenderer(1240, 650, {
			'view': document.getElementById('example'), 'backgroundColor': 0x1099BB
			});

			var pixiStage = new PIXI.Container();

			var agent;
			var agent2;
			var test;
			var state;
			var functionGameloop;
			var pixiBunny;
			var farBackground;
			var midBackground;

			PIXI.loader
				.add("agent.png")
				.add("tilesheet.png")
				.load(setup);
			function setup(){
				/*var agent = new PIXI.Sprite(
					PIXI.loader.resources["agent.png"].texture
				);*/
				/*var tilesheet = new PIXI.Sprite(
					PIXI.loader.resources["tilesheet.png"].texture
				);*/
				agent = PIXI.utils.TextureCache["agent.png"];
				var tilesheet = PIXI.utils.TextureCache["tilesheet.png"];

				var rec = new PIXI.Rectangle(269, 0, 20, 20);
				tilesheet.frame = rec;
				test = new PIXI.Sprite(tilesheet);

				farBackground = new PIXI.extras.TilingSprite(PIXI.Texture.fromImage("resources/bg-far.png"), 1240, 512);
				midBackground = new PIXI.extras.TilingSprite(PIXI.Texture.fromImage("resources/bg-mid.png"), 1240, 512);

				pixiBunny = new PIXI.Sprite(PIXI.Texture.fromImage('http://mercury.cs.pdx.edu/bunny.png'));
				pixiBunny.position.x = Math.random() * 800.0;
				pixiBunny.position.y = Math.random() * 600.0;
				pixiBunny.anchor.x = 0.5;
				pixiBunny.anchor.y = 0.5;

				farBackground.position.x = 0;
				farBackground.position.y = 0;
				farBackground.tilePosition.x = 0;
				farBackground.tilePosition.y = 0;
				/*farBackground.width = pixiRenderer.width;
				farBackground.height = pixiRenderer.height;*/

				midBackground.position.x = 0;
				midBackground.position.y = pixiRenderer.height/2;
				midBackground.tilePosition.x = 0;
				midBackground.tilePosition.y = 0;
				//midBackground.tilePosition.y = pixiRenderer.height * 0.65;
				//midBackground.width = pixiRenderer.width;
				//midBackground.height = midBackground.position.y - pixiRenderer.height;


				var rec2 = new PIXI.Rectangle(12, 5, 25, 42);
				agent.frame = rec2;
				agent2 = new PIXI.Sprite(agent)

				test.position.x = 100;
				test.position.y = 100;

				agent2.position.x = 200;
				agent2.position.y = 200;
				agent2.anchor.x = 0.5;
				agent2.anchor.y = 0.5;

				pixiStage.addChild(farBackground);
				pixiStage.addChild(midBackground);
				pixiStage.addChild(agent2);

				pixiStage.addChild(test);
				pixiStage.addChild(pixiBunny);

				agent2.vx = 0;
				agent2.vy = 0;
				document.addEventListener('keydown', keyDown);
				document.addEventListener('keyup', keyUp);

				state = play;

				functionGameloop();
			}

			function functionGameloop() {

				state();

				pixiRenderer.render(pixiStage);
				requestAnimationFrame(functionGameloop);

			};

			function play(){
				agent2.position.x += agent2.vx;
				agent2.position.y += agent2.vy;

				farBackground.tilePosition.x -= 0.256;
				midBackground.tilePosition.x -= 0.512;

				if (checkForCollisions(agent2, pixiBunny)){
					console.log("Hit");
				}
			}

			function keyDown(key){
				//a
				if(key.keyCode === 65){
					if(agent2.position.x - agent2.width/2 > 0 ){
						//agent2.position.x -= 2;
						agent2.vx = -2;
						agent2.vy = 0;
					}
				}
				//d
				if(key.keyCode === 68){
					if(agent2.position.x + agent2.width/2 < pixiRenderer.width){
						//agent2.position.x += 2;
						agent2.vx = 2;
						agent2.vy = 0;
						console.log(agent2.vx);
					}
				}
				//w
				if(key.keyCode === 87){
					if(agent2.position.y - agent2.height/2 > 0){
						agent2.vy = -2;
						agent2.vx = 0;
					}
				}
				//s
				if(key.keyCode === 83){
					if(agent2.position.y + agent2.height/2 < pixiRenderer.height){
						agent2.vy = 2;
						agent2.vx = 0;
						console.log(agent2.vy);
					}
				}
			}

			function keyUp(key){
				if(key.keyCode === 87 || key.keyCode === 83){
					agent2.vy = 0;
				}
				if(key.Code === 68 || key.keyCode === 65){
					agent2.vx = 0;
				}

			}

			function checkForCollisions(obj1, obj2){
				var collision = false;

				//Calculate the center of all objects
				obj1.xCenter = obj1.position.x + (obj1.width/2);
				obj1.yCenter = obj1.position.y + (obj1.height/2);
				obj2.xCenter = obj2.position.x + (obj2.width/2);
				obj2.yCenter = obj2.position.y + (obj2.height/2);

				//Distance between the objects
				var distX = Math.abs(obj1.xCenter - obj2.xCenter);
				var distY = Math.abs(obj1.yCenter - obj2.yCenter);
				//console.log("x " + distX + " y " + distY);

				if(distX < (obj1.width/2 + obj2.width/2)){
					if(distY < (obj1.height/2 + obj2.height/2)){
						collision = true;
					}
					else{
						collision = false;
					}
				}
				else{
					collision = false;
				}
				return collision;
			}



		</script>
	</body>
</html>
